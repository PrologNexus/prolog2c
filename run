#!/bin/scheme /grass/19/boot
;;;; compile + run program -*- Scheme -*-


(require 'sh 'match)

;(run-verbose #t)
(define opts '("-g" "-save-temps=obj" "-DTRACE"))
(define args (command-line-arguments))

(match args
  (("-O" . _)
   (pop! args)
   (set! opts '("-O3" "-fomit-frame-pointer" "-fno-strict-aliasing" "-fwrapv" "-DUNSAFE")))
  (_ #f))

(define file (car args))
(define bfile (basename file))
(define xfile (strip-suffix bfile))
(define cfile (replace-suffix "c" bfile))

(let ((s (suffix file)))
  (unless (string=? "c" s)
    (run (./pc ,file -o ,cfile))))

(run (gcc -std=gnu99 -I. ,cfile -o ,xfile -lm ,@opts))
(exit (run* (,(string-append "./" xfile) ,@(cdr args))))
