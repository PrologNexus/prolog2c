#!/bin/scheme /grass/17/boot
;;;; compile + run program -*- Scheme -*-


(require 'sh 'match)

;(run-verbose #t)
(define opts '("-g" "-save-temps=obj" "-DTRACE" "-DEBUG_GC"))
(define moreopts '())
(define args (command-line-arguments))

(let loop ()
  (match args
    (("-O" . _)
     (pop! args)
     (set! opts '("-O3" "-fomit-frame-pointer" "-fno-strict-aliasing" "-fwrapv" "-DUNSAFE"))
     (loop))
    (("-m32" . _)
     (pop! args)
     (push! "-m32" moreopts)
     (loop))
    (_ #f)))

(define file (car args))
(define bfile (basename file))
(define xfile (strip-suffix bfile))
(define cfile (replace-suffix "c" bfile))

(let ((s (suffix file)))
  (unless (string=? "c" s)
    (run (./pc -n -q ,file -o ,cfile))))

(run (gcc -std=gnu99 -Ilib -I. ,@opts ,@moreopts ,cfile -o ,xfile -lm -lrt))
(exit (run* (,(string-append "./" xfile) ,@(cdr args))))
