NOTES											              -*- Org -*-


* Issues
** Major
*** TODO Term-comparison doesn't handle cyclic structures, yet
*** TODO Why is so much space accumulating on arg- and env-stacks?
*** 0028-endless-tailcall crashes in pi
    - hits some limit, not sure which.
    - is in any case not keeping the memory-use constant.
*** TODO [#B] Implementation of if-then-else seems to be broken
   - if-then stack gets out of balance, found here:
     call_primitive('->', 2, TERM) :-
	!,
	arg(1, TERM, X), arg(2, TERM, Y),
	execute(X) -> execute(Y). % parsed as (!, ...) -> execute(Y)
   - adding parens around last goal repaired the problem, but still
     this shouldn't happen.
*** 0007-pi benchmark needs high memory/trail settings
    - crashes with defaults, which is to be expected, but it would be
      nice to catch this properly.
*** 32-bit version can't tokenize fractional part of real if it doesn't fit into an integer
   - e.g.:
     main :- f(0.463647609000806).
*** Everything is still rather slow and uses too much memory
   - see file:broken-tests/
*** Once trail-stack reserve is reached, GC will happen all the time if the trail can't be reduced
*** If heap is insufficient deref_term/3 will loop endlessly
   - also read_atom/2, recorded/X, retract/1 and clause/X
*** name/2 and functor/3 (and others?) may exceed heap-reserve for large inputs
   - atom_codes/2 could fail on full heap, force GC and retry,
     would need to be moved into file:lib/misc.pl
** Minor
*** is integer_rounding_function really "towards_zero"?
*** Fresh checkout often leaves file:g-s-p.pl uncompiled
    - only rebuilds g-s-p.c, but that might not be sufficient.
    - but "make clean" should be sufficient.
*** pb should understand "volatile"
*** Failure in term_expansion/2 will simply be ignored
*** The output of TRACE_TAILCALL() is somewhat confusing
    - Not sure if arguments output reflects the correct state.
    - can we get rid of this?
*** Reduce memory use in pc
    - seems to build up a lot of choice points.
*** Erasing a db-entry that is already marked is currently ignored
   - actual deletion will happen on next GC.
   - should we throw an error?
   - note that 0069-cdb deletes twice: first the retract of hello(X)
     and then the abolish of hello/1.
*** Handle freezing of db-refs
   - delete from deleted-items list?
   - what can happen?
   - currently caught by assertion in freeze_term_recursive()
*** Using multiple threads is currently not possible
   - all static vars would have to be declared TLS, but these may not
     be statically initialized with non-constants, and this applies to
     many data objects for literals.
   - but user-defined literals can't be shared, or not?
*** TODO 0046-arithmetic test fails in 32-bit pc
*** Unbound var in arithmetic expr doesn't show variable name
   - extend var-rep to hold name, in addition to index.
*** Reader-error should throw syntax_error with message argument
*** Throw ISO-compliant exceptions everywhere
    - at least as much as possible and sensible.
*** Isn't most of the stuff in file:lib/ordset.pl, file:lib/sets.pl determinate?
* Optimization opportunities
** TODO Special case long lists of facts
   - facts that only contain atomic arguments should be compiled into
     more space-efficient code.
   - more general: if all arguments in clause are ground, unify static
     array of literals with args (unify_literals(ARGS, LITERALS) ->
     bool)
   - measure impact in speed, size and compile-times.
** If clause contains a single tail-call, CP-creation could be avoided
   - saves little, though.
** Remove unused predicates
   - could be done in assembly-stage
     - register called predicates (and caller), compute unused
       predicates and predicates used by other unused predicates and
       drop sections of pseudo-instructions.
     - add pseudo-instructions for marking start + end of predicate
       definition.
** Peephole optimization of pseudo-instructions
** Environment trimming
   - sort variables by lifetime (reversed) and trim env_top after last use.
   - may only be applicable when env_top didn't change.
** Add "determinate" declarations and green cuts in library code
   - profile to find suitable points of improvement.
** Special-case calls of primitives that are known to always succeed
** DONE Take advantage of timestamps when binding vars in unify()
   - implemented in branch /bind-younger/ and seems to work, but trail
     is not slightly smaller.
** writeq/1 could use foreign_call(basic_writeq(X)) for atoms
   - but the name needs to be classified anyway, because of the possibly
     required space in front of it.
** Arithmetic
   - deref all vars just once at start.
   - track types, use unboxed math.
** 2-stream unification
   - rather complicated, first attempt at implementation ended in
     quite a mess and was abandoned.
** With some sort of type/groundness analysis many primitives could be optimized
   - functor, arg, name, univ, etc.
   - rewrite to simpler forms.
** Perform first match in C when looking up DB-entry
   - full unification may not trail properly due to timestamp issues.
   - could at least perform a simple match without binding variables.
   - must pass term to match in first-lookup and lookup for next item.
** current_op/3 needs fast path when operator name is known
   - could use single-bucket db, with unififcation inside
     db_find/db_next (provided, we implement matching in file:pc.h)
** Deterministic goal in condition of if-then-else can drop some of the CP dance
   - same for '\\+'/2, once/1
   - fail could actually just perform a jump, perhaps redefine FAIL
     temporarily (or use intermediate macro).
** Analyze program before compiling to pseudo-instructions
   - perform determinacy-analysis for all code.
   - in other words: actually take advantage of having a static whole-program compiler.
* Features
** TODO if term_expansion/2 returns list, treat as separate (or no) terms
   - add this also to /pi-in-pc/
** Predicates
   - ground/1
   - rename_file/2, delete_file/1
** TODO Add more ISO stuff
   - set_stream_position/2
   - get_char, put_char, peek_char
   - write/2, writeq/2
** TODO catch SIGINT (others?) and throw exception
   - user_interrupt
   - perhaps: signal(SIGNUM)
** dlopen, dlsym, to access primitives written in C
** Show warning for untriggered delayed goals with "-:d"
   - check trail-entries when unwinding trail and before exit.
** Allow access to delay goals
   - frozen(VAR, PTRARGS) :: return ptr/args pairs,
        non-deterministically
** Unicode
   - arbitrary character codes in strings (UTF-8?)
   - atom-length (string_length())
   - extend name/2, get/1, get0/1, put/1, skip/1 (and probably many
     more)
   - different handling of put_code/put_byte, get_code/get_byte and
     peek_code/peek_byte
** Allow "library(ATOM)" as file-spec
   - consult/1, include/1, ensure_loaded/1
   - would this simply prepend "lib/"?
** Extend numerical operators
   - constants "pi", perhaps "e"
   - "asin", "acos"
* Documentation
** DONE News
   - char_code/2, atom_concat/3, atom_chars/2, atom_length/2,
     current_input/1, current_output/1, number_chars/2, nl/1,
     put_byte/1, put_byte/2, put_code/1, put_code/2, get_byte/1,
     get_byte/2, get_code/1, get_code/2, peek_byte/1, peek_byte/2,
     peek_code/1, peek_code/2, read/2, display/2, write/2, writeq/2,
     put_char/1, put_char/2, get_char/1, get_char/2, peek_char/1,
     peek_char/2
   - close/1, set_input/1, set_output/1, set_error_output/1,
     at_end_of_stream/0, at_end_of_stream/1, flush_output/1
   - renamed flush/0 to flush_output/1.
   - pi: more robust with respect to current I/O ports in case of
     exceptions.
   - single-element list in arithmetic expressions.
   - cycle-handling has been added to many builtins.
   - acyclic_term/1, unify_with_occurs_check/2
   - min and max in arithmetic expressions.
   - current_prolog_flag/2
   - repl in pi doesn't pile up trail anymore.
   - more lightweight copy_term/2, added duplicate_term/2
   - read_line/1
   - speed- and memory-profiling.
   - string-canonicalization didn't handle empty strings.
   - pb: "-i" option.
   - pb: handling "\" inside text (not followed by WS + NL)
   - pb: fixed handling zero-argument function with result.
   - pb: "/* success */" result modifier.
   - once/1
   - undefined goals in interpreter throw error.
   - slightly faster db-key computation.
   - ensure_loaded/1 directive.
   - added -q option to pi, also added some verbose output when including/consulting.
** Missing ISO predicates
   | Name                                         | Remarks                                       |
   |----------------------------------------------+-----------------------------------------------|
   | sub_atom/5                                   |                                               |
   | current_predicate/1                          | unimplemented                                 |
   | set_prolog_flag/2                            | unimplemented, as they are no changable flags |
   | call/1                                       | unimplemented                                 |
   | close/2                                      | unimplemented                                 |
   | set_stream_position/2                        |                                               |
   | stream_property/2                            |                                               |
   | char_conversion/2, current_char_conversion/2 | unimplemented                                 |
   | read_term/2, read_term/3                     |                                               |
   | write_canonical/1, write_canonical/2         |                                               |
   | write_term/2, write_term/3                   |                                               |
* Diagnostics
** Detect singleton variables
** Report unused predicates
* Experimental
** DONE /pi-in-pc/ (make interpreter available in compiler)
   - use of term_expansion/2 is awkward, but handy.
   - allows arbitrary latent goals.
   - compare file-size + compile overhead in optimized mode.
   - would allow conditional compilation.
** prolog-implementation of CDB
   - needs tree-based DB, perhaps using lib/tree23.
   - problematic, as it depends on GC'd trailed vars and needs 2 tree
     lookups for recording (to add a new element to an existing list of
     old vals: first to get old, second to put old with new added)
     - update_23 allows this, by adding a variable and unifying it
       with the result-"mode".
   - term-copying needed for storing new DB in global copies whole
     DB, which is too inefficient.
     - might be addressed by more efficient deref_all()
   - dbreference type changes.
** DONE /intmath/ (integer-only math)
   - lib/rdtok returns end_of_file when reading flonum (which makes pi
     terminate, for example)
   - would have to disable flonum-parsing in rdtok, which needs
     conditional, depending on variant (with flonums or without)
* Runtime
** TODO Use macro to check for exceeded heap-limit
* Tests
** TODO Evaluate memprofiling
   - do we need to update counts on fail or (re-)throw?
** TODO profile with gprof
* Test suites
** file:/archive/prologsuite.tar.gz
** file:/archive/inriasuite.tar.gz
** file:/archive/iclpgcbenches.tar.gz
* Undocumented features
** Compiler
*** '$predicate_address'/2
** Builtins
*** read1/2
*** '$call_predicate'/2
*** Single-element list in arithmetic expressions
** Interpreter
*** expand_term/2 + term_expansion/2
* Extensions
** Things in the DEC10 library that might be interesting
   - arrays.pl, logarr.pl
   - ask.pl, read_sent.pl
   - heap.pl, map.pl, trees.pl
   - queues.pl
* Release steps
** Document changes
** make fullcheck
** Test on WIN64
** Test on Mac
** Test on [pi], [call-cc]
** Test dist
** Tag, push, upload
** Bump version (file:README + file:lib/flags.pl)
