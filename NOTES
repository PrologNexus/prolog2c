NOTES											              -*- Org -*-


* Issues
** Major
*** TODO discontiguous doesn't work with "wildcard" PI
    - e.g. ":- discontiguous bar." with defs for bar/0 and bar/1.
    - matching of N/A when collecting clauses for one of the two
      functors seems to get confused.
    - not completely sure whether ISO allows PI without arity.
*** TODO embedded test fails on [z]
    - exit_code doesn't seem to be initialized.
    - is TERMINATE(..., EXIT_SUCCESS) called?
*** TODO 0046-arithmetic test fails in 32-bit pc
    - seems to be a parsing problem.
*** TODO Term-comparison doesn't handle cyclic structures, yet
*** 0028-endless-tailcall crashes in pi
    - hits some limit, not sure which.
    - is in any case not keeping the memory-use constant.
*** Implementation of if-then-else seems to be broken
   - if-then stack gets out of balance, found here:
     call_primitive('->', 2, TERM) :-
	!,
	arg(1, TERM, X), arg(2, TERM, Y),
	execute(X) -> execute(Y). % parsed as (!, ...) -> execute(Y)
   - adding parens around last goal repaired the problem, but still
     this shouldn't happen.
   - didn't occur lately, not sure if this is still relevant.
*** 32-bit version can't tokenize fractional part of real if it doesn't fit into an integer
   - e.g.:
     main :- f(0.463647609000806).
*** Everything is still rather slow and uses too much memory
   - see file:broken-tests/
*** TODO Once trail-stack reserve is reached, GC will loop if the trail can't be reduced
    - remember trail_top when trailing triggers GC and avoid another
      trailing-induced GC if the trail_top is not significantly below
      the remembered one.
    - still indicates insufficient trail-stack, show warning in
      verbose mode.
*** If heap is insufficient deref_term/4 will loop endlessly
   - also recorded/X, retract/1 and clause/X, atom_codes/2,
     number_codes/2.
*** functor/3 (and others?) may exceed heap-reserve for large inputs
** Minor
*** TODO ensemble: prefix msgs with special byte
    - to detect invalid output of subprocesses.
*** TODO The interpreter should accept but ignore some compiler-specific directives
    - determinate, mode, meta_predicate
*** discontiguous/1 is not available in the interpreter
*** TODO standard-ports should have some initial data
    - alias, type, mode.
*** '$call' doesn't check argc nor whether argument is ptr
    - needs to be safer, should it be exposed (or "meta_predicate"
      is made official)
*** pi: call/1 should probably handle X^Y terms (quantified)
*** split_string/4 does not retain empty strings
    - this is incompatible to SWIs version.
*** TODO Eliminate redundant switch-operations
    - e.g.:
      #+BEGIN_SRC prolog
      foo(a, 1).
      foo(b, 1).
      foo(c, 1).
      foo(d, 1).
      #+END_SRC
      produces 4 switch_on_atom operations.
    - see compile_dispatch_sequence in file:index.pl
*** is integer_rounding_function really "towards_zero"?
*** Fresh checkout often leaves file:g-s-p.pl uncompiled
    - only rebuilds g-s-p.c, but that might not be sufficient.
    - but "make clean" should be sufficient.
    - still the case?
*** The output of TRACE_TAILCALL() is somewhat confusing
    - Not sure if arguments output reflects the correct state.
    - can we get rid of this?
*** Erasing a db-entry that is already marked as erased is currently ignored
   - actual deletion will happen on next GC.
   - should we throw an error?
   - note that 0069-cdb deletes twice: first the retract of hello(X)
     and then the abolish of hello/1.
*** Handle freezing of db-refs
   - delete from deleted-items list?
   - what can happen?
   - currently caught by assertion in freeze_term_recursive()
*** Using multiple threads is currently not possible
   - all static vars would have to be declared TLS, but these may not
     be statically initialized with non-constants, and this applies to
     many data objects for literals.
   - but user-defined literals can't be shared, or not?
*** Unbound var in arithmetic expr doesn't show variable name
   - extend var-rep to hold name, in addition to index.
*** file:rdtok.pl doesn't handle integer with radix with radix length > 1
*** Reader-error should throw syntax_error with message argument
*** Throw ISO-compliant exceptions everywhere
    - at least as much as possible and sensible.
*** Isn't most of the stuff in file:lib/ordset.pl, file:lib/sets.pl determinate?
* Optimization opportunities
** TODO Find a more efficient way of compiling unifications
** TODO Check whether -fwhole-program makes a difference (or works at all)
** TODO Add macros for trivial lib predicates
   | asserta/1                 | would need to introduce var |
   | assertz/1                 | s.a.                        |
   | clause/2                  | s.a.                        |
   | $findall_start/0          |                             |
   | seen/0                    |                             |
   | told/0                    |                             |
   | tab/1                     |                             |
   | get/1                     |                             |
   | skip/1                    |                             |
   | open/3                    |                             |
   | open/4                    |                             |
   | read_string/2             |                             |
   | read_line/1               |                             |
   | set_input/1               |                             |
   | set_output/2              |                             |
   | flush_output/0            |                             |
   | flush_output/1            |                             |
   | at_end_of_stream/0        |                             |
   | at_end_of_stream/1        |                             |
   | put_char/1                | s.a.                        |
   | put_char/2                |                             |
   | is_list/1                 |                             |
   | shell/1                   |                             |
   | unify_with_occurs_check/2 |                             |
   | char_code/2               |                             |
   | list_to_ord_set/2         |                             |
   | ord_seteq/2               |                             |
   | recorded/2                | s.a.                        |
   | recorda/2                 | s.a.                        |
   | recordz/2                 | s.a.                        |
   | keysort/2                 |                             |
   | sort/2                    |                             |
   | merge/3                   |                             |
** TODO Add mode-declarations for internally used predicates
** Results of memory profile for pc, compiling itself 
   - commit f254da345c8df3997b56c3d84dd1e35cdfe12e0d
   $start/0                                 C:    88   T:     0   E:     8   H:    56 
   read_lookup/2                            C:    88   T:     3   E:    34   H:     5M
   read_digits/5                            C:    88   T:    19   E:    62   H:     0 
   read_digits/4                            C:    88   T:     0   E:    40   H:    13K
   read_integer/3                           C:    88   T:    32   E:    40   H:    20K
   read_fullstop/3                          C:    88   T:    16   E:    16   H:     0 
   read_symbol/3                            C:   132   T:    39   E:    45   H:   181K
   read_name/3                              C:   116   T:    12   E:    22   H:   6.2M
   read_solidus/2                           C:    88   T:     0   E:    23   H:   274K
   read_solidus/3                           C:    89   T:    70   E:    46   H:    22K
   escaped_char/2                           C:    88   T:    16   E:     0   H:     0 
   more_string/4                            C:    88   T:    32   E:    40   H:     0 
   read_string/4                            C:    92   T:    16   E:    95   H:   479K
   read_string/3                            C:    88   T:     0   E:    32   H:   279K
   read_after_atom/3                        C:    88   T:     8   E:    24   H:   306K
   read_number/4                            C:    88   T:    16   E:   119   H:    51K
   read_tokens/3                            C:   113   T:    53   E:   128   H:   6.5M
   read_tokens/2                            C:    88   T:     2K  E:    32   H:    78K
   $record_db_key/2                         C:    88   T:    16   E:    24   H:     0 
   $record_db_match/3                       C:    88   T:     1   E:    54   H:2.2e+02M
   recorded/3                               C:    88   T:    16   E:    72   H:   4.8M
   recorded/2                               C:    88   T:     0   E:    24   H:   341K
   $record/4                                C:    88   T:    32   E:    48   H:   2.7M
   recordz/3                                C:    88   T:     0   E:    24   H:     0 
   recordz/2                                C:    88   T:     0   E:    24   H:  0.99M
   recorda/3                                C:    88   T:     0   E:    24   H:     0 
   recorda/2                                C:    88   T:     0   E:    24   H:   288 
   memberchk/2                              C:    88   T:     0   E:    36   H:   1.8M
   length/2                                 C:   340   T:    57   E:    89   H:   5.6M
   reverse/3                                C:    88   T:     4   E:    25   H:     1M
   reverse/2                                C:    88   T:     0   E:    16   H:     0 
   append/3                                 C:    88   T:    15   E:    24   H:    51M
   member/2                                 C:    88   T:     2   E:    36   H:    84M
   number_codes/2                           C:    88   T:     9   E:    29   H:   3.1M
   atom_codes/2                             C:    88   T:    16   E:    27   H:    11M
   copy_term/2                              C:    88   T:     0   E:    32   H:     0 
   deref_term/4                             C:    88   T:    16   E:    40   H:    16M
   $univ_args/4                             C:    88   T:    12   E:    54   H:   4.7M
   =../2                                    C:   109   T:     7   E:    54   H:    11M
   name/2                                   C:   107   T:     0   E:    35   H:     0 
   compare/3                                C:    88   T:    16   E:    25   H:     0 
   $findall_collect/3                       C:    88   T:     1   E:    31   H:    12M
   $findall_collect/1                       C:    88   T:     0   E:    16   H:   251K
   $findall_push/1                          C:    90   T:    32   E:    32   H:    12M
   $findall_start/0                         C:    88   T:     0   E:     0   H:     0 
   $atomic_list_concat/2                    C:   364   T:   128   E:    74   H:   9.4M
   atomic_list_concat/2                     C:   642   T:   254   E:   149   H:   759K
   atom_concat/3                            C:   176   T:   189   E:   149   H:     2K
   subtract/3                               C:    88   T:     4   E:    30   H:    98K
   intersection/3                           C:    88   T:     0   E:    67   H:    39K
   union/3                                  C:    88   T:    15   E:    32   H:   4.5M
   keysort/2                                C:    88   T:     0   E:    16   H:     0 
   combine/3                                C:    88   T:    16   E:     9   H:     0 
   compare/4                                C:    88   T:     0   E:    48   H:   184K
   compare/5                                C:    88   T:    16   E:    48   H:    92K
   merge/5                                  C:   898   T:   496   E:   741   H:  0.98M
   $sort_halve/4                            C:    88   T:    21   E:    50   H:   410K
   sort/4                                   C:     1K  T:   504   E:   873   H:   333K
   told/0                                   C:    88   T:     0   E:     8   H:    32 
   tell/1                                   C:   117   T:     0   E:    10   H:    72 
   seen/0                                   C:    88   T:     0   E:     8   H:   864 
   see/1                                    C:   117   T:     0   E:     8   H:     1K
   exprtl/6                                 C:   319   T:   289   E:   241   H:   1.1M
   cant_follow_expr/2                       C:    88   T:     0   E:     0   H:     0 
   exprtl0/5                                C:    88   T:   110   E:   345   H:   7.4M
   prefix_is_atom/2                         C:    99   T:     0   E:   105   H:    33K
   peepop/2                                 C:    88   T:    16   E:    56   H:    17K
   after_prefix_op/7                        C:   133   T:   368   E:   189   H:     8K
   read_list/3                              C:    88   T:    56   E:    62   H:    94K
   read_args/3                              C:    88   T:    50   E:    42   H:   1.4M
   read/5                                   C:    88   T:    78   E:   154   H:   3.7M
   read/4                                   C:   155   T:   261   E:    81   H:   1.3M
   ambigop/6                                C:   264   T:     0   E:    48   H:     0 
   infixop/4                                C:    88   T:    48   E:    32   H:     0 
   postfixop/3                              C:   176   T:     0   E:    40   H:     0 
   prefixop/3                               C:   173   T:     0   E:    39   H:     0 
   expect/3                                 C:    88   T:    16   E:    16   H:    28K
   all_read/1                               C:    88   T:     0   E:  -296   H:     0 
   read1/2                                  C:    88   T:     2K  E:     0   H:   118K
   read1/1                                  C:    88   T:     0   E:    16   H:    39K
   current_op/3                             C:    88   T:     0   E:    32   H:   665K
   is_opchar/1                              C:    88   T:     0   E:     8   H:     0 
   classify_other_tail/1                    C:   117   T:     0   E:     5   H:     1K
   classify_alpha_tail/1                    C:   120   T:     0   E:    12   H:    27K
   classify_name/2                          C:   159   T:    16   E:    28   H:    19K
   write_atom/4                             C:    88   T:    32   E:   104   H:     4K
   write_oper/5                             C:    88   T:     0   E:    40   H:     0 
   write_out/7                              C:    88   T:   104   E:   120   H:     7K
   write_out/5                              C:    97   T:     2   E:   141   H:    14K
   maybe_space/2                            C:    88   T:     0   E:    21   H:     0 
   maybe_paren/5                            C:    88   T:    16   E:    64   H:     0 
   write/1                                  C:    88   T:     0   E:    16   H:     3K
   $forall_11650/3                          C:    88   T:     0   E:    48   H:   384 
   $findall_5127/2                          C:   176   T:    16   E:    16   H:     0 
   $findall_2249/6                          C:   176   T:     0   E:    48   H:    24K
   $findall_2229/4                          C:   176   T:     0   E:    32   H:    12K
   $findall_2210/5                          C:   176   T:     0   E:    40   H:    20K
   $findall_1752/7                          C:   176   T:     0   E:    56   H:    10K
   $findall_1688/7                          C:   176   T:     0   E:    56   H:    14K
   $findall_1423/6                          C:   176   T:     0   E:    48   H:     1K
   $findall_1373/4                          C:   176   T:     0   E:    32   H:    34K
   $findall_1066/4                          C:   176   T:     0   E:    32   H:   800 
   $findall_1053/3                          C:   176   T:     0   E:    24   H:     2K
   $findall_226/3                           C:   176   T:     0   E:    24   H:     0 
   $forall_160/2                            C:    88   T:     0   E:    32   H:     0 
   parse_arguments/1                        C:   484   T:   152   E:   228   H:     1K
   set_library_path/0                       C:   264   T:    32   E:    56   H:   296 
   compile/1                                C:    39K  T:   186K  E:    26K  H:    32 
   main/0                                   C:     0   T:     0   E:     0   H:   320 
   register_defined_predicate/1             C:   218   T:    47   E:    87   H:    32K
   register_unresolved_call/1               C:   291   T:    26   E:    28   H:     0 
   generate_literal_list/1                  C:    88   T:     0   E:    12   H:    32K
   generate_slot_inits/3                    C:    88   T:     0   E:    41   H:   116K
   generate_foreign_arguments/1             C:    88   T:     0   E:    15   H:    44K
   generate_data_list/1                     C:    88   T:     0   E:    14   H:   747K
   generate_static_literals/6               C:     3K  T:     1K  E:     1K  H:    53K
   generate_static_literal/4                C:    10K  T:     3K  E:     3K  H:   177K
   assemble_literals/2                      C:    88   T:     1K  E:    48   H:   118K
   gen_label_or_index/1                     C:    88   T:     0   E:    16   H:     0 
   assemble_structure_dispatch/4            C:    28K  T:     6K  E:     7K  H:   119K
   assemble_atom_dispatch/4                 C:    18K  T:     4K  E:     5K  H:   128K
   assemble_arguments/2                     C:    88   T:     0   E:    25   H:   399K
   assemble/3                               C:   311   T:    62   E:    75   H:   2.7M
   generate_trailer/0                       C:    88   T:     0   E:     0   H:     0 
   generate_verbatim_code/0                 C:    88   T:     0   E:     8   H:    32 
   generate_header/0                        C:   264   T:    48   E:    40   H:    64 
   assemble_instructions/1                  C:    88   T:   110   E:    32   H:   2.8M
   assemble_global_variables/2              C:    88   T:    41   E:    41   H:   320 
   assemble_file/2                          C:     1K  T:   159K  E:   456   H:   128 
   make_unbound_vars/4                      C:   224   T:    53   E:    82   H:    16K
   register_literals/4                      C:   138   T:   105   E:    62   H:    77K
   register_literal/4                       C:    88   T:    55   E:    32   H:    91K
   both_determinate/3                       C:    88   T:    16   E:    35   H:    19K
   emit/4                                   C:   616   T:   128   E:   264   H:     0 
   emit/3                                   C:   440   T:    96   E:   184   H:     0 
   emit/2                                   C:   264   T:    64   E:   112   H:     0 
   emit/1                                   C:    88   T:     0   E:     8   H:     0 
   compile_arithmetic_operation_arguments/5 C:     1K  T:   386   E:   532   H:    94K
   arithmetic_operation/3                   C:    88   T:    16   E:     0   H:     0 
   arithmetic_operation/2                   C:    88   T:     0   E:     0   H:     0 
   compile_arithmetic_expression/5          C:   648   T:   209   E:   397   H:    64K
   compile_arithmetic_test/6                C:     2K  T:   654   E:     1K  H:    21K
   compile_order_predicate/3                C:    88   T:     0   E:    64   H:    64 
   type_predicate/1                         C:    88   T:     0   E:     0   H:     0 
   compile_type_predicate/2                 C:   119   T:     3   E:    30   H:    95K
   compile_call/6                           C:   109   T:     7   E:   106   H:    59K
   compile_ordinary_call/7                  C:     1K  T:   342   E:   386   H:   346K
   compile_meta_predicate/9                 C:   427   T:     0   E:   104   H:   103K
   compile_explicit_unification/7           C:     2K  T:   907   E:     1K  H:    25K
   compile_body_expression/8                C:     2K  T:     1K  E:     2K  H:   8.4M
   compile_body/5                           C:     3K  T:     2K  E:     3K  H:   295K
   compile_term_arguments/7                 C:     1K  T:   637   E:   747   H:   1.9M
   compile_term_for_unification/6           C:   646   T:   242   E:   326   H:     1M
   compile_unification1/7                   C:     1K  T:   556   E:   700   H:   791K
   compile_unification/7                    C:     2K  T:   960   E:     1K  H:   513K
   compile_head/5                           C:   185   T:   159   E:   203   H:   200K
   secondary_clause_label/4                 C:     3K  T:     1K  E:   859   H:   348K
   clause_label/4                           C:     3K  T:     1K  E:   976   H:   369K
   compile_redo/2                           C:   151   T:    23   E:    44   H:    21K
   show_compiled_clause/1                   C:    88   T:     0   E:    16   H:     0 
   compile_clause/6                         C:    10K  T:     6K  E:     5K  H:   752K
   compile_clause_list/5                    C:     6K  T:    11K  E:     2K  H:   705K
   compile_clauses/4                        C:    22K  T:    39K  E:    10K  H:    99K
   check_unresolved_calls/0                 C:    88   T:     0   E:     8   H:    32 
   process_initialization_goals/1           C:    88   T:    96   E:    48   H:   280 
   process_boilerplate_code/1               C:   176   T:    80   E:    40   H:   448 
   compile_block/4                          C:    22K  T:    39K  E:    10K  H:    10K
   process_directive/3                      C:   960   T:   324   E:   389   H:    12K
   process_input/4                          C:   424   T:     8K  E:   366   H:  0.97M
   compile_file_finished/1                  C:    10K  T:   172K  E:     5K  H:    32 
   compile_file/1                           C:    88   T:    16   E:    24   H:    64 
   is_meta_predicate/3                      C:    88   T:     0   E:    24   H:    64K
   determinate_builtin/2                    C:    88   T:     0   E:    13   H:    42K
   add_boilerplate/2                        C:    97   T:    32   E:    22   H:     0 
   auto_include/3                           C:    88   T:     1   E:    22   H:     0 
   macro/2                                  C:   173   T:    19   E:   108   H:   2.9M
   build_dispatch_table_entry/2             C:    88   T:    16   E:    27   H:    19K
   build_dispatch_table/7                   C:     5K  T:     2K  E:     4K  H:    22K
   find_free_dispatch_table_entry/4         C:    88   T:    16   E:    93   H:     5K
   insert_dispatch_table_entries/4          C:    88   T:    25   E:    54   H:    11K
   duplicate_dispatch_table_entries/3       C:   140   T:   101   E:    96   H:   144K
   adjust_dispatch_table/4                  C:    15K  T:     8K  E:    12K  H:     1K
   dispatch_instruction/2                   C:    88   T:    16   E:     4   H:     5K
   compile_dispatch_sequence/6              C:     9K  T:     2K  E:     3K  H:   161K
   compile_dispatch_integer_fail/6          C:     4K  T:     1K  E:     1K  H:     1K
   compile_dispatch/5                       C:    22K  T:     7K  E:     9K  H:    62K
   member_in_indexing_types/2               C:    88   T:     0   E:    46   H:   1.9M
   scan_indexing_types/3                    C:   150   T:    38   E:   124   H:   344K
   compile_clause_indexing/5                C:    12K  T:     4K  E:     4K  H:    49K
   get_argument_type/2                      C:    88   T:    16   E:    34   H:   123K
   build_index_to_type_map/3                C:   129   T:    95   E:    91   H:   627K
   possibly_cyclic_unification/1            C:   199   T:    77   E:    64   H:    23K
   goals_and_variables/4                    C:     5K  T:     2K  E:     3K  H:     3K
   map_indexed_variables_to_real_variables/3 C:   740   T:   244   E:   485   H:   103K
   collect_indexed_variables/3              C:   585   T:   208   E:   153   H:   238K
   collect_indexed_variables/2              C:    88   T:    48   E:    32   H:   176K
   ground_term/1                            C:   104   T:    16   E:    36   H:   1.9M
   indexed_variable/2                       C:    88   T:     0   E:    16   H:   4.3M
   index_variables/5                        C:   106   T:   557   E:   121   H:    10M
   index_variables/3                        C:    88   T:     0   E:    32   H:    38K
   open_file_stack/3                        C:    88   T:    23   E:    32   H:    10K
   gensym/4                                 C:    88   T:    16   E:    48   H:   4.8M
   gen_literal_index/3                      C:    88   T:    32   E:    32   H:   137K
   gen_label/3                              C:    88   T:     0   E:    24   H:     0 
   initial_state/1                          C:    88   T:    16   E:     0   H:     0 
   locate_file/2                            C:   365   T:   246   E:    91   H:     2K
   map_second/2                             C:    88   T:    16   E:    24   H:    14K
   concatenate/2                            C:     1K  T:   301   E:   321   H:    12M
   hexdigit/2                               C:    88   T:    16   E:    22   H:     0 
   mangle_char/2                            C:    88   T:    16   E:    10   H:   3.4M
   mangle_name/2                            C:     2K  T:   565   E:   588   H:   1.4M
   file_name_string/2                       C:    88   T:    64   E:    24   H:    56 
   message/1                                C:   176   T:     0   E:    16   H:     1K
   gen/5                                    C:    88   T:     0   E:    40   H:     0 
   gen/4                                    C:    88   T:     0   E:    32   H:     0 
   gen/3                                    C:    88   T:     0   E:    24   H:     0 
   gen/2                                    C:    88   T:     0   E:    16   H:     0 
   gen/1                                    C:    88   T:     0   E:     8   H:     0 
   default_setting/2                        C:    88   T:    14   E:     0   H:     0 
   <system>                                 C:     0   T:     0   E:     0   H:     1K
** gprof reports very heavy use of make_var()
   - force inlining? (check whether -O2 inlines it)
** Deref arguments in advance
** Use power-of-2 sized hash-tables for indexing
   - use binary-and instead of mod operation, supposed to be faster.
** If clause contains a single tail-call, CP-creation could be avoided
   - saves little, though.
** Remove unused predicates
   - could be done in assembly-stage
     - register called predicates (and caller), compute unused
       predicates and predicates used by other unused predicates and
       drop sections of pseudo-instructions.
     - add pseudo-instructions for marking start + end of predicate
       definition.
** Peephole optimization of pseudo-instructions
   - needs thorough analysis of occurring patterns.
** Environment trimming
   - sort variables by lifetime (reversed) and trim env_top after last use.
   - may only be applicable when env_top didn't change.
** Add "determinate" declarations and green cuts in library code
   - profile to find suitable points of improvement.
** Special-case calls of primitives that are known to always succeed
   - avoids test for failure.
** DONE Take advantage of timestamps when binding vars in unify()
   - implemented in branch /bind-younger/ and seems to work, but trail
     is not slightly smaller.
** writeq/1 could use foreign_call(basic_writeq(X)) for atoms
   - but the name needs to be classified anyway, because of the
     possibly required space in front of it (or embedded quotes, which
     must be doubled)
** Arithmetic
   - deref all vars just once at start.
   - track types, use unboxed math.
** 2-stream unification
   - rather complicated, first attempt at implementation ended in
     quite a mess and was abandoned.
** With some sort of type/groundness analysis many primitives could be optimized
   - perform local flow-analysis before compiling list of clauses for
     a predicate, collecting type/groundness info for each variable.
   - functor, arg, name, univ, etc.
   - rewrite to simpler forms.
** Perform first match in C when looking up DB-entry
   - full unification may not trail properly due to timestamp issues.
   - could at least perform a simple match without binding variables.
   - must pass term to match in first-lookup and lookup for next item.
** current_op/3 needs fast path when operator name is known
   - could use single-bucket db, with unififcation inside
     db_find/db_next (provided, we implement matching in file:pc.h)
** Determinate goal in condition of if-then-else can drop some of the CP dance
   - same for '\\+'/2, once/1
   - fail could actually just perform a jump, perhaps redefine FAIL
     temporarily (or use intermediate macro).
** Analyze program before compiling to pseudo-instructions
   - perform determinateness-analysis for all code.
   - in other words: actually take advantage of having a static whole-program compiler.
* Features
** Allow serializing DB to and from file
** TODO Check if we can use file:lib/canon.pl for printing query results
** DONE if term_expansion/2 returns list, treat as separate (or no) terms
   - add this also to /pi-in-pc/
** Handle arbitrary signals
** dlopen, dlsym, to access primitives written in C
** Show warning for untriggered delayed goals with "-:d"
   - check trail-entries when unwinding trail and before exit.
** pb extensions
*** TODO pb should understand "volatile"
** Allow access to delayed goals
   - frozen(VAR, PTRARGS) :: return ptr/args pairs,
        non-deterministically
** Unicode
   - arbitrary character codes in strings (UTF-8?)
   - pc.h: string_length(), to_string(), string_to_list()
   - builtins that would have to be changed:
     | atom_codes/2  |
     | get/1         |
     | get0/1        |
     | put/1         |
     | skip/1        |
     | read_line/X   |
     | read_string/X |
     | sub_atom/5    |
   - different handling of put_code/put_byte, get_code/get_byte and
     peek_code/peek_byte
* Documentation
** TODO Document non-autoload libraries
   - only roughly, not in detail.
   - libs: arrays, assoc, bits, canon, heaps, logarr, map, path, pp,
     queues, rbtrees, s11n, tree23, numvars
   - explain usage, mention autoloads.
** TODO List differences to ISO in file:README
** DONE News
   - current_prolog_flag: address_bits(N)
   - added support for "discontiguous" directive, changed
     "determinate" into an operator.
   - pb: handles "fail" mode (opposite of "success").
   - the compiler skips the first line of the source-program if it
     starts with "#".
   - added stream_property/2 (position + tty properties)
   - current_prolog_flag/2 understands apple, windows, unix
   - Added builtins put/2, tab/2, skip/2, get/2, get0/2, is_list/1,
     exists_directory/1, atomic_list_concat/2, split_string/4,
     sub_atom/5, append/2, read_line/2, read_string/3,
     set_stream_position/2, close/2, chdir/1, getcwd/1, nth/3
   - Added support for stream aliases "current_input",
     "current_output", "user_input", "user_output" and "user_error".
   - Dropped peek/1
   - pi: Respects PC_LIBRARY_DIR.
   - removed "-I" option, added "-n"
   - PC_INCLUDE_PATH has been renamed PC_LIBRARY_DIR and is only
     allowed to contain a single directory.
   - Filenames may now be "library(NAME)", refering to the current
     library directory.
** Add pc-autocompile to dist and document
   - find a better name.
** Missing ISO predicates
   | Name                                         | Remarks                                        |
   |----------------------------------------------+------------------------------------------------|
   | current_predicate/1                          | unimplemented                                  |
   | set_prolog_flag/2                            | unimplemented, as there are no changable flags |
   | call/1                                       | unimplemented                                  |
   | close/2                                      | unimplemented                                  |
   | set_stream_position/2                        | too vague to be useful                         |
   | stream_property/2                            |                                                |
   | char_conversion/2, current_char_conversion/2 | unimplemented                                  |
   | read_term/2, read_term/3                     |                                                |
   | write_canonical/1, write_canonical/2         |                                                |
   | write_term/2, write_term/3                   |                                                |
** ISO-extensions ISO DTR 13211-1:2006
   | log/2, atan/2, asin/1, acos/1, | arithmetic expressions                    |
   | epsilon/0, pi/0, e/0           | arithmetic constants                      |
   | ^/2                            | integer exponentation (error on overflow) |
* Tests
** TODO add edcg test, using lib/pp
** TODO port file:broken-tests/r6rs-sem.pl
** TODO 32-bit tests are unnecessary on 32-bit platform
** Examples for ensemble:
   #+BEGIN_SRC prolog
%%% producer example for ensemble -*- Prolog -*-

:- ensure_loaded(library(ensemble)).

main :-
	between(1, 10, I),
	sleep(1),
	fwritef(user_error, "producer: %d\n", [I]),
	mwrite(counter(I)),
	fail.
main :-
	mterminate.

%%% consumer example for ensemble -*- Prolog -*-

:- ensure_loaded(library(ensemble)).

main :-
	repeat,
	mread(counter(I)),
	fwritef(user_error, "consumer: %d\n", [I]),
	fail.

%%% listener (relay) example for ensemble -*- Prolog -*-

:- ensure_loaded(library(ensemble)).

main :-
	tell(yyy),
	mregister_relay,
	repeat,
	mreceive(MSG),
	writef("%q.\n", [MSG]),
	fail.
   #+END_SRC
* Diagnostics
** Detect singleton variables
** Report unused predicates
* Experimental
** TODO investigate C compiler options
   - check out ACOVEA: 
     - http://merlin.fit.vutbr.cz/wiki/index.php/Acovea_tutorial
     - http://www.gentoo-wiki.info/Acovea
     - debian package acovea, use with "runacovea"
   - compare settings with regard to speed, size and compile-time.
   - find Feeley's genetic algorithm.
   - check options used in gambit (as this also generates large
     functions)
** DONE /pi-in-pc/ (make interpreter available in compiler)
   - use of term_expansion/2 is awkward, but handy.
   - allows arbitrary latent goals.
   - compare file-size + compile overhead in optimized mode.
   - would allow conditional compilation.
** DONE /intmath/ (integer-only math)
   - lib/rdtok returns end_of_file when reading flonum (which makes pi
     terminate, for example)
   - would have to disable flonum-parsing in rdtok, which needs
     conditional, depending on variant (with flonums or without)
* Runtime
** TODO Use macro to check for exceeded heap-limit
* Test suites
** file:/archive/prologsuite.tar.gz
** file:/archive/inriasuite.tar.gz
** file:/archive/iclpgcbenches.tar.gz
* Undocumented features
** Compiler
*** '$predicate_address'/2
*** "meta_predicate" directive and usage
    - see file:tests/0116-meta.pl
*** "public" declaration
    - see file:tests/0117-public.pl
** Builtins
*** slice/4
*** deref_term/4
*** read1/2
*** '$call'/2
*** Single-element list in arithmetic expressions
** Interpreter
*** expand_term/2 + term_expansion/2
* Release steps
** Document changes
** make fullcheck
** Test on WIN64
** Test on Mac
** Test on [pi], [call-cc]
** Test dist
** Tag, push, upload
** Bump version (file:README + file:lib/flags.pl)
