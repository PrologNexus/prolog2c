#!/bin/bash
### wrapper script for pc/pi
#
# usage: qp [OPTION ...] FILENAME ARGUMENT ...


## Change these to your liking: ############################################

# don't forget a trailing slash
PC_PREFIX=
PC_INCLUDEPATH=.
OPTFLAGS="-O2 -fomit-frame-pointer -DNDEBUG"
CC=gcc
CACHEDIR="${HOME}/.qp"

############################################################################

set -e

if test -z "$1"; then
    exec ${PC_PREFIX}pi
fi

PC_OPTIONS=
C_OPTIONS=
LIBRARY_DIR=
PC_SOURCEFILE=
OFILE=

while test -n "$1"; do
    case "$1" in
	-h|-help|--help)
	    echo "usage: qp -help"
	    echo "       qp -version"
	    echo -n "       qp [-v] [-compress-facts] [-o OUTFILENAME] [-C COPTION] [-O0] [-i] [-n] [-g] [-xref] "
	    echo "[COPTION ...] [FILENAME ARGUMENT ...]"
	    echo "       qp -purge [FILENAME ...]"
	    exit;;
	-version)
	    exec ${PC_PREFIX}pc -version;;
	-g)
	    C_OPTIONS="${C_OPTIONS} -DTRACE -g"
	    OPTFLAGS=
	    shift;;
	-C)
	    shift
	    C_OPTIONS="${C_OPTIONS} $1"
	    shift;;
	-xref)
	    XREF=1
	    shift;;
	-o) 
	    shift
	    OFILE="$1"
	    shift;;
	-purge)
	    shift
	    test -d "${CACHEDIR}" || exit
	    if test -z "$1"; then
		rm -f "${CACHEDIR}"/*
	    else
		while test -n "$1"; do
		    HASH=`md5sum "${1}" | sed -e 's/^\([a-f0-9]\+\).*$/\1/'`
		    rm -f "${CACHEDIR}/${HASH}"
		    shift
		done
	    fi
	    exit;;
	-O0)
	    OPTFLAGS=
	    shift;;
	-n|-compress-facts|-i)
	    PC_OPTIONS="${PC_OPTIONS} $1"
	    shift;;
	-*|*.o)
	    C_OPTIONS="${C_OPTIONS} $1"
	    shift;;
	*)
	    PC_SOURCEFILE="$1"
	    shift;;
    esac
done

test -n "$XREF" && exec ${PC_PREFIX}pc -xref ${PC_OPTIONS} ${PC_SOURCEFILE}

if test \! -d "${CACHEDIR}"; then
    mkdir "${CACHEDIR}"
fi

HASH=`md5sum "${PC_SOURCEFILE}" | sed -e 's/^\([a-f0-9]\+\).*$/\1/'`

if test -z "${HASH}"; then
    echo "invalid ${PC_SOURCEFILE}" >2
    exit 1
fi

if test -x "${CACHEDIR}/${HASH}"; then
    exec "${CACHEDIR}/${HASH}" "$@"
fi

PC_SOURCEFILE2=`basename "${PC_SOURCEFILE}"`
CFILE=`mktemp --tmpdir qp-XXXXX.c`
${PC_PREFIX}pc -q "${PC_SOURCEFILE}" ${PC_OPTIONS} -o "${CFILE}"
"$CC" -std=gnu99 ${OPTFLAGS} -fno-strict-aliasing -fwrapv \
    -I${PC_INCLUDEPATH} -I. "${CFILE}" -o "${CACHEDIR}/${HASH}" \
    -lm -lrt ${C_OPTIONS} 
rm -f "${CFILE}"

if test -n "$OFILE"; then
    cp "${CACHEDIR}/${HASH}" "$OFILE"
else
    exec "${CACHEDIR}/${HASH}" "$@"
fi
